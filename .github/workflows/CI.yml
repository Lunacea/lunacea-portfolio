name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip-tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean

# 最小権限の原則: 各Jobで必要な権限のみを個別に設定
permissions:
  contents: read
  security-events: write
  packages: write
  id-token: write

jobs:
  # 並列実行可能なJob群
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-lint-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-lint-
            ${{ runner.os }}-bun-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run linting
        run: bun run lint --max-warnings 0
      
      - name: Run type checking
        run: bun run typecheck
      
      - name: Upload lint results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            .eslintcache
            tsconfig.tsbuildinfo
          retention-days: 7

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-tests }}
    permissions:
      contents: read
    strategy:
      matrix:
        node-version: [18, 20]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'bun'
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-test-${{ matrix.node-version }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-test-${{ matrix.node-version }}-
            ${{ runner.os }}-bun-test-
            ${{ runner.os }}-bun-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run tests
        run: bun run test -- --coverage
      
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: |
            test-results/
            coverage/
          retention-days: 7

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always() && (needs.lint.result == 'success' && (needs.test.result == 'success' || needs.test.result == 'skipped'))
    permissions:
      contents: read
    outputs:
      build-id: ${{ steps.build-info.outputs.build-id }}
      build-size: ${{ steps.build-info.outputs.build-size }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-build-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-build-
            ${{ runner.os }}-bun-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build application
        id: build
        run: bun run build
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ secrets.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}
      
      - name: Extract build information
        id: build-info
        run: |
          if [ -f ".next/BUILD_ID" ]; then
            BUILD_ID=$(cat .next/BUILD_ID)
            echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          fi
          BUILD_SIZE=$(du -sh .next/ | cut -f1)
          echo "build-size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "Build ID: $BUILD_ID"
          echo "Build Size: $BUILD_SIZE"
      
      - name: Verify build output
        run: |
          echo "Build output contents:"
          ls -la .next/
          echo "BUILD_ID exists: $([ -f ".next/BUILD_ID" ] && echo "YES" || echo "NO")"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: .next/
          retention-days: 7

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip-tests && needs.build.result == 'success' }}
    permissions:
      contents: read
    strategy:
      matrix:
        browser: [chromium, webkit, firefox]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-e2e-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-e2e-
            ${{ runner.os }}-bun-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: .next/
        continue-on-error: true
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/package-lock.json', '**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-${{ matrix.browser }}-
            ${{ runner.os }}-playwright-
      
      - name: Install Playwright
        run: |
          # CI環境では依存関係のインストールをスキップして高速化
          if [ "${{ matrix.browser }}" = "chromium" ]; then
            bunx playwright install chromium --with-deps
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            bunx playwright install firefox --with-deps
          elif [ "${{ matrix.browser }}" = "webkit" ]; then
            bunx playwright install webkit --with-deps
          else
            bunx playwright install --with-deps ${{ matrix.browser }}
          fi
      
      - name: Run E2E tests
        run: bunx playwright test --project=${{ matrix.browser }}
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          ARCJET_ENV: "development"
          NODE_ENV: "test"
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "test-key"
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: "http://localhost:3000/sign-in"
          # BGMプレイヤーのテスト用環境変数
          NEXT_PUBLIC_ENABLE_BGM: "true"
          NEXT_PUBLIC_BGM_AUTOPLAY: "false"
          NEXT_PUBLIC_BGM_VOLUME: "0.5"
          # ビジュアルテスト用環境変数
          NEXT_PUBLIC_DISABLE_BGM_MODAL: "true"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 7
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Fail on high severity vulnerabilities
        if: failure()
        run: |
          echo "High severity vulnerabilities detected. Please review and fix them."
          exit 1
      
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: trivy-results.sarif
          retention-days: 30

  # Crowdin統合は専用ワークフロー（crowdin.yml）で処理

  # デプロイメント用のJob（本番環境へのデプロイは環境保護ルールを経由）
  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: [build, e2e, security-scan]
    if: always() && needs.build.result == 'success' && needs.e2e.result == 'success' && needs.security-scan.result == 'success'
    environment: ${{ inputs.environment || 'staging' }}
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: .next/
      
      - name: Deploy to environment
        run: |
          echo "Deploying to ${{ inputs.environment || 'staging' }} environment"
          echo "Build ID: ${{ needs.build.outputs.build-id }}"
          echo "Build Size: ${{ needs.build.outputs.build-size }}"
          # ここに実際のデプロイロジックを追加
          # 例: Vercel, Netlify, AWS S3, etc.
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful to ${{ inputs.environment || 'staging' }}"
          else
            echo "❌ Deployment failed to ${{ inputs.environment || 'staging' }}"
          fi
