# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: CD Pipeline

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      skip-migrations:
        description: 'Skip database migrations'
        required: false
        default: false
        type: boolean

# æœ€å°æ¨©é™ã®åŸå‰‡: å„Jobã§å¿…è¦ãªæ¨©é™ã®ã¿ã‚’å€‹åˆ¥ã«è¨­å®š
permissions:
  contents: read
  deployments: write
  packages: read

# ç’°å¢ƒå¤‰æ•°ã¯å„ã‚¹ãƒ†ãƒƒãƒ—ã§ç›´æ¥å‚ç…§ï¼ˆè­¦å‘ŠæŠ‘åˆ¶ã®ãŸã‚ï¼‰

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 
      name: ${{ inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.deployment-url }}
    permissions:
      contents: read
      deployments: write
      packages: read
    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
      deployment-status: ${{ steps.deploy.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Bun Environment
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-cd-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-cd-
            ${{ runner.os }}-bun-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Download build artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: .next/
        continue-on-error: true
      
      - name: Build application (if artifacts not available)
        if: failure()
        run: bun run build
      
      - name: Deploy to ${{ inputs.environment || 'production' }}
        id: deploy
        run: |
          echo "ğŸš€ Deploying to ${{ inputs.environment || 'production' }} with Nixpacks..."
          echo "deployment-url=https://${{ inputs.environment || 'production' }}.your-app.com" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          # ã“ã“ã§Nixpacksãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
          # ä¾‹: nixpacks deploy ã¾ãŸã¯ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
        # ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ™ãƒ«ã§å®šç¾©æ¸ˆã¿
      
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä½¿ç”¨ã—ã¦ã„ãªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      # - name: Run Prisma migrations
      #   if: success() && !inputs.skip-migrations
      #   run: |
      #     echo "ğŸ”„ Running database migrations..."
      #     if [ -n "$DATABASE_URL" ]; then
      #       bun run db:migrate
      #     else
      #       echo "âš ï¸ DATABASE_URL not set, skipping migrations"
      #     fi
      #   env:
      #     DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Health check
        if: success()
        run: |
          echo "ğŸ¥ Performing health check..."
          # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          # ä¾‹: curl -f https://${{ inputs.environment || 'production' }}.your-app.com/api/health
      
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ inputs.environment || 'production' }}',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: '${{ steps.deploy.outputs.status }}',
              environment_url: '${{ steps.deploy.outputs.deployment-url }}'
            });
